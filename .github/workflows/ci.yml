name: CI

on:
  pull_request:
    branches: ['**']

jobs:
  test:
    runs-on: patient_staging_test
      
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.9
        uses: actions/setup-python@v3
        with:
          python-version: '3.9.19'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # Create .env file with ALL required variables
      - name: Create .env file
        run: |
          cat <<EOF > .env
          # Database
          DB_SERVER_DEV=${{ secrets.DB_SERVER_DEV }}
          DB_DATABASE_DEV=${{ secrets.DB_DATABASE_DEV }}
          DB_DATABASE_PORT=${{ secrets.DB_DATABASE_PORT }}
          DB_USERNAME_DEV=${{ secrets.DB_USERNAME_DEV }}
          DB_PASSWORD_DEV=${{ secrets.DB_PASSWORD_DEV }}
          DB_DRIVER_DEV=${{ secrets.DB_DRIVER_DEV }}
          
          # Cloudinary
          CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }}
          
          # Web
          WEB_FE_ORIGIN=${{ secrets.WEB_FE_ORIGIN }}
          
          # RabbitMQ
          RABBITMQ_HOST=localhost
          RABBITMQ_PORT=5672
          RABBITMQ_USER=testuser
          RABBITMQ_PASS=testpassword
          RABBITMQ_VIRTUAL_HOST=/
          RABBITMQ_DEFAULT_USER=testuser
          RABBITMQ_DEFAULT_PASS=testpassword
          EOF
          
          # Verify .env was created
          cat .env | grep -v 'PASSWORD' # Print non-sensitive vars for debugging

      - name: Start RabbitMQ container
        run: |
          # Create config file
          mkdir -p rabbitmq-config
          echo "cluster_formation.peer_discovery_backend = classic_config" > rabbitmq-config/rabbitmq.conf
          echo "vm_memory_high_watermark.relative = 0.6" >> rabbitmq-config/rabbitmq.conf
          
          # Start container with memory limits
          docker run -d \
            --name rabbitmq \
            --memory="800m" \
            --memory-swap="1g" \
            -e RABBITMQ_DEFAULT_USER=testuser \
            -e RABBITMQ_DEFAULT_PASS=testpassword \
            -v $(pwd)/rabbitmq-config:/etc/rabbitmq \
            -p 5672:5672 \
            192.168.188.184:5000/rabbitmq_service_dev:latest
          
          # Wait with longer timeout and retries
          for i in {1..5}; do
            if docker exec rabbitmq rabbitmqctl wait --pid 1 --timeout 60; then
              break
            else
              echo "Retry $i/5..."
              sleep 5
            fi
          done


      # Verification steps
      - name: Verify RabbitMQ
        run: |
          docker ps -a
          docker logs rabbitmq
          nc -vz localhost 5672
          docker exec rabbitmq rabbitmqctl status

      # Run tests with all environment variables available
      - name: Run pytest
        run: |
          pytest -v

      # Cleanup
      - name: Clean up containers
        if: always()
        run: |
          docker stop rabbitmq || true
          docker rm rabbitmq || true
