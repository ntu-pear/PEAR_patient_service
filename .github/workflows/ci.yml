name: CI

on:
  pull_request:
    branches: ['**']

jobs:
  ci-staging:
    # This will be the default CI job for everything except for Main branch.
    uses: ./.github/workflows/base-ci.yml
    with:
      environment: 'staging'
      runner-label: 'patient_staging'
      python-version: '3.9.19'

      # Staging images
      rabbitmq-image: '192.168.188.184:5000/rabbitmq_service_dev:latest'
      activity-service-image: '192.168.188.186:5000/activity_service_dev:latest'
      scheduler-service-image: '192.168.188.173:5000/pear_schedule:latest'

    # The "secrets.XXXX" are passed in from GitHub secrets
    secrets:
      DB_SERVER: ${{ secrets.DB_SERVER_STAGING }} # Staging server DB
      DB_DATABASE_DEV: ${{ secrets.DB_DATABASE_DEV }}
      DB_DATABASE_PORT: ${{ secrets.DB_DATABASE_PORT }}
      DB_USERNAME: ${{ secrets.DB_USERNAME_DEV }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD_DEV }}
      DB_DRIVER_DEV: ${{ secrets.DB_DRIVER_DEV }}
      CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
      CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
      CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
      WEB_FE_ORIGIN: ${{ secrets.WEB_FE_ORIGIN }}
      RABBITMQ_VIRTUAL_HOST: ${{ secrets.RABBITMQ_VIRTUAL_HOST }}


  ci-prod:
    if: github.base_ref == 'main' && github.event_name == 'pull_request'
    uses: ./.github/workflows/base-ci.yml
    with:
      environment: 'production'
      runner-label: patient
      python-version: '3.9.19'

      # Production images (use staging ones for now)
      rabbitmq-image: '192.168.188.184:5000/rabbitmq_service_dev:latest'
      activity-service-image: '192.168.188.186:5000/activity_service_prod:latest'
      scheduler-service-image: '192.168.188.173:5000/pear_schedule_prod:latest'

    secrets:
      DB_SERVER: ${{ secrets.DB_SERVER_PROD }}
      DB_DATABASE_DEV: ${{ secrets.DB_DATABASE_DEV }}
      DB_DATABASE_PORT: ${{ secrets.DB_DATABASE_PORT }}
      DB_USERNAME: ${{ secrets.DB_USERNAME_DEV }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD_DEV }}
      DB_DRIVER_DEV: ${{ secrets.DB_DRIVER_DEV }}
      CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
      CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
      CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
      WEB_FE_ORIGIN: ${{ secrets.WEB_FE_ORIGIN }}
      RABBITMQ_VIRTUAL_HOST: ${{ secrets.RABBITMQ_VIRTUAL_HOST }}