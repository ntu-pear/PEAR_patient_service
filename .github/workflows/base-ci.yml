name: Base CI

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      runner-label:
        required: true
        type: string
      python-version:
        required: false
        type: string
        default: '3.9.19'

      rabbitmq-image:
        required: true
        type: string
      activity-service-image:
        required: true
        type: string
      scheduler-service-image:
        required: true
        type: string
    
    # These are passed in from ci.yml
    secrets:
      DB_SERVER:
        required: true
      DB_DATABASE:
        required: true
      DB_DATABASE_PORT:
        required: true
      DB_USERNAME:
        required: true
      DB_PASSWORD:
        required: true
      DB_DRIVER:
        required: true
      CLOUDINARY_CLOUD_NAME:
        required: true
      CLOUDINARY_API_KEY:
        required: true
      CLOUDINARY_API_SECRET:
        required: true
      WEB_FE_ORIGIN:
        required: true
      RABBITMQ_HOST:
        required: true
      RABBITMQ_PORT:
        required: true
      RABBITMQ_VIRTUAL_HOST:
        required: true

jobs:
  tests:
    runs-on: ${{ inputs.runner-label }}
    environment: test

    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ inputs.python-version }}
        uses: actions/setup-python@v3
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

        # The "secrets.XXX" here are mapped from whats passed in from ci.yml
      - name: Create .env file
        run: |
          cat <<EOF > .env
          SERVICE_NAME=${{ vars.SERVICE_NAME }} # Taken directly from GitHub settings, not ci.yml

          # Database
          DB_SERVER=${{ secrets.DB_SERVER }}
          DB_DATABASE=${{ secrets.DB_DATABASE }}
          DB_DATABASE_PORT=${{ secrets.DB_DATABASE_PORT }}
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_DRIVER=${{ secrets.DB_DRIVER }}
          
          # Cloudinary
          CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }}
          
          # Web
          WEB_FE_ORIGIN=${{ secrets.WEB_FE_ORIGIN }}
          
          # RabbitMQ local instance for Integration Test
          RABBITMQ_HOST=localhost
          RABBITMQ_PORT=5672
          RABBITMQ_USER=CI_TestUser
          RABBITMQ_PASS=CI_TestPassword
          RABBITMQ_VIRTUAL_HOST=/
          RABBITMQ_DEFAULT_USER=CI_TestUser
          RABBITMQ_DEFAULT_PASS=CI_TestPassword
          EOF
          grep -v 'PASSWORD' .env
      
      - name: Pull Docker images
        run: |
          # RabbitMQ
          docker pull ${{ inputs.rabbitmq-image }}
          # Activity Service
          docker pull ${{ inputs.activity-service-image }}
          # Scheduler Service
          docker pull ${{ inputs.scheduler-service-image }}

      - name: Create Docker network
        run: docker network create integration-test-net || true

      - name: Start RabbitMQ
        run: |
          # Create configuration directory and file
          mkdir -p rabbitmq-config
          cat << EOF > rabbitmq-config/rabbitmq.conf
          # Disable cluster peer discovery
          cluster_formation.peer_discovery_backend = classic_config

          
          # Enable management plugin
          management.tcp.port = 15672
          management.tcp.ip = 0.0.0.0
          
          # Log to stdout
          log.console = true
          log.console.level = info
          EOF

          # Create a custom entrypoint script to handle cookie permissions
          cat << 'EOF' > rabbitmq-entrypoint.sh
          #!/bin/bash
          set -e
          
          # Ensure directory exists
          mkdir -p /var/lib/rabbitmq
          
          # Set Erlang cookie with proper permissions
          echo "TESTCOOKIE123" > /var/lib/rabbitmq/.erlang.cookie
          chown rabbitmq:rabbitmq /var/lib/rabbitmq/.erlang.cookie
          chmod 600 /var/lib/rabbitmq/.erlang.cookie
          
          
          # Start RabbitMQ
          exec docker-entrypoint.sh rabbitmq-server
          EOF
          
          chmod +x rabbitmq-entrypoint.sh
          
          # Start container with configuration
          docker run -d \
            --name rabbitmq \
            --memory="800m" \
            -e RABBITMQ_ERLANG_COOKIE="TESTCOOKIE123" \
            -e RABBITMQ_DEFAULT_USER=${{ inputs.rabbitmq-user }} \
            -e RABBITMQ_DEFAULT_PASS=${{ inputs.rabbitmq-pass }} \
            -v $(pwd)/rabbitmq-config:/etc/rabbitmq \
            -v $(pwd)/rabbitmq-entrypoint.sh:/usr/local/bin/custom-entrypoint \
            --entrypoint /usr/local/bin/custom-entrypoint \
            -p 5672:5672 \
            -p 15672:15672 \
            ${{ inputs.rabbitmq-image }}
      
      - name: Start Activity service
        run: |
          docker run -d \
            --name activity \
            --network integration-test-net \
            --env-file .env \
            ${{ inputs.activity-service-image }}

      - name: Start Scheduler service
        run: |
          docker run -d \
            --name scheduler \
            --network integration-test-net \
            --env-file .env \
            ${{ inputs.scheduler-service-image }}

      - name: Test unit tests with pytest
        run: |
          python -m pytest tests/unit

      - name: Cleanup
        if: always()
        run: |
          docker stop rabbitmq || true
          docker rm rabbitmq || true

          docker stop activity || true
          docker rm activity || true

          docker stop scheduler || true
          docker rm scheduler || true
  integration-tests:
    runs-on: [self-hosted, Linux, X64, patient]
    needs: tests
    environment: ${{ inputs.environment }}
    env:
      SERVICE_NAME: ${{ vars.SERVICE_NAME }}
      DB_DATABASE: ${{ secrets.DB_DATABASE }}
      DB_DRIVER: ${{ secrets.DB_DRIVER }}
      DB_SERVER: ${{ secrets.DB_SERVER }}
      DB_DATABASE_PORT: ${{ secrets.DB_DATABASE_PORT }}
      DB_USERNAME: ${{ secrets.DB_USERNAME }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      RABBITMQ_HOST: ${{ secrets.RABBITMQ_HOST }}
      RABBITMQ_PORT: ${{ secrets.RABBITMQ_PORT }}
      RABBITMQ_USER: ${{ secrets.RABBITMQ_USER }}
      RABBITMQ_PASS: ${{ secrets.RABBITMQ_PASS }}
      RABBITMQ_VIRTUAL_HOST: ${{ secrets.RABBITMQ_VIRTUAL_HOST }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.9.19
        uses: actions/setup-python@v3
        with:
          python-version: '3.9.19'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Check app imports
        run: |
          python -c "from app.main import app; print('All imports successful')"

      - name: Test integration tests with pytest
        run: |
          python -m pytest tests/integration